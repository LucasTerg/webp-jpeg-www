import{J as O}from"./vendor-529iNPX7.js";console.log("Client processor module loaded");const U=p=>new Promise((l,f)=>{const a=new Image;a.onload=()=>l(a),a.onerror=f,a.src=URL.createObjectURL(p)}),X=(p,l,f)=>{const a=p.getImageData(0,0,l,f).data;let d=0,w=f,g=0,x=l;const I=(c,i,n,b)=>{const A=c>230&&i>230&&n>230,v=b<255;return A||v};for(d=0;d<f;d++){let c=!1;for(let i=0;i<l;i++){const n=(d*l+i)*4;if(!I(a[n],a[n+1],a[n+2],a[n+3])){c=!0;break}}if(c)break}if(d===f)return null;for(w=f-1;w>=d;w--){let c=!1;for(let i=0;i<l;i++){const n=(w*l+i)*4;if(!I(a[n],a[n+1],a[n+2],a[n+3])){c=!0;break}}if(c)break}for(g=0;g<l;g++){let c=!1;for(let i=d;i<=w;i++){const n=(i*l+g)*4;if(!I(a[n],a[n+1],a[n+2],a[n+3])){c=!0;break}}if(c)break}for(x=l-1;x>=g;x--){let c=!1;for(let i=d;i<=w;i++){const n=(i*l+x)*4;if(!I(a[n],a[n+1],a[n+2],a[n+3])){c=!0;break}}if(c)break}return{x:g,y:d,width:x-g+1,height:w-d+1}},K=async(p,l,f)=>{const a=new O,{baseName:d,startNumber:w,optCrop:g,optTrimOnly:x,optAddMargin:I,optResize:c}=l;let i=0;for(let b=0;b<p.length;b++){const v=p[b].file;f&&f(`Przetwarzanie: ${v.name} (${b+1}/${p.length})`);try{const h=await U(v);let o=document.createElement("canvas");o.width=h.width,o.height=h.height;let y=o.getContext("2d",{willReadFrequently:!0});y.drawImage(h,0,0);let T=!1,E=!1;if(g||x){const t=[{x:0,y:0},{x:h.width-1,y:0},{x:0,y:h.height-1},{x:h.width-1,y:h.height-1}],e=y.getImageData(0,0,h.width,h.height).data;for(let r of t){const s=(r.y*h.width+r.x)*4,k=e[s],R=e[s+1],F=e[s+2],J=e[s+3];if(k>230&&R>230&&F>230||J<255){T=!0;break}}}if(g||x){const t=X(y,o.width,o.height);if(t){(t.width<o.width||t.height<o.height)&&(E=!0);const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(o,t.x,t.y,t.width,t.height,0,0,t.width,t.height),o=e,y=r}}const L=g&&!x&&(T||E)||I,S=L?10:0,_=3e3,j=3600,W=_-S,$=j-S;let u=o.width,C=o.height;if(u>W||C>$){const t=Math.min(W/u,$/C),e=Math.floor(u*t),r=Math.floor(C*t),s=document.createElement("canvas");s.width=e,s.height=r;const k=s.getContext("2d");k.drawImage(o,0,0,e,r),o=s,y=k,u=e,C=r}if(L){const t=document.createElement("canvas");t.width=u+10,t.height=C+10;const e=t.getContext("2d");e.fillStyle="#ffffff",e.fillRect(0,0,t.width,t.height),e.drawImage(o,5,5),o=t,y=e,u+=10,C+=10}if(c){const t=Math.max(u,500),e=Math.max(C,500);if(u<t||C<e){const r=document.createElement("canvas");r.width=t,r.height=e;const s=r.getContext("2d");s.fillStyle="#ffffff",s.fillRect(0,0,t,e);const k=Math.floor((t-u)/2),R=Math.floor((e-C)/2);s.drawImage(o,k,R),o=r,y=s}}const m=document.createElement("canvas");m.width=o.width,m.height=o.height;const B=m.getContext("2d");B.fillStyle="#ffffff",B.fillRect(0,0,m.width,m.height),B.drawImage(o,0,0);const z=(t,e)=>new Promise(r=>t.toBlob(s=>r(s),"image/jpeg",e)),D=1.5*1024*1024,H=3*1024*1024;let M;if(M=await z(m,.99),M.size>D){let t=await z(m,.96);t.size<=H?M=t:(t=await z(m,.92),t.size<=H?M=t:(t=await z(m,.89),t.size<=H?M=t:M=await z(m,.85)))}const N=`${d}-${w+b}.jpg`;a.file(N,M),i++}catch(h){console.error("Błąd przetwarzania klienta:",h),f&&f(`Błąd: ${v.name}`)}}return f&&f("Pakowanie ZIP..."),await a.generateAsync({type:"blob"})};export{K as processFilesClientSide};
//# sourceMappingURL=client-processor-DndueCvx.js.map
