{"version":3,"file":"client-processor-D-td7EAr.js","sources":["../../src/js/client-processor.js"],"sourcesContent":["import JSZip from 'jszip';\n\nconsole.log(\"Client processor module loaded\");\n\n// Funkcja pomocnicza do ładowania obrazu\nconst loadImage = (file) => {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.onload = () => resolve(img);\n    img.onerror = reject;\n    img.src = URL.createObjectURL(file);\n  });\n};\n\n// Algorytm TRIM (Scanlines)\nconst getTrimmedBounds = (ctx, width, height) => {\n  const pixels = ctx.getImageData(0, 0, width, height).data;\n  let top = 0, bottom = height, left = 0, right = width;\n\n  // Funkcja sprawdzająca czy piksel jest \"tłem\" (biały lub przezroczysty)\n  // Tolerancja dla bieli: RGB > 230\n  const isBackground = (r, g, b, a) => {\n    const isWhite = r > 230 && g > 230 && b > 230;\n    const isTransparent = a < 255;\n    return isWhite || isTransparent;\n  };\n\n  // Skanowanie z góry\n  for (top = 0; top < height; top++) {\n    let rowHasContent = false;\n    for (let x = 0; x < width; x++) {\n      const i = (top * width + x) * 4;\n      if (!isBackground(pixels[i], pixels[i+1], pixels[i+2], pixels[i+3])) {\n        rowHasContent = true;\n        break;\n      }\n    }\n    if (rowHasContent) break;\n  }\n\n  // Jeśli obraz jest pusty (samo tło)\n  if (top === height) return null;\n\n  // Skanowanie z dołu\n  for (bottom = height - 1; bottom >= top; bottom--) {\n    let rowHasContent = false;\n    for (let x = 0; x < width; x++) {\n      const i = (bottom * width + x) * 4;\n      if (!isBackground(pixels[i], pixels[i+1], pixels[i+2], pixels[i+3])) {\n        rowHasContent = true;\n        break;\n      }\n    }\n    if (rowHasContent) break;\n  }\n  // Skanowanie z lewej\n  for (left = 0; left < width; left++) {\n    let colHasContent = false;\n    for (let y = top; y <= bottom; y++) {\n      const i = (y * width + left) * 4;\n      if (!isBackground(pixels[i], pixels[i+1], pixels[i+2], pixels[i+3])) {\n        colHasContent = true;\n        break;\n      }\n    }\n    if (colHasContent) break;\n  }\n\n  // Skanowanie z prawej\n  for (right = width - 1; right >= left; right--) {\n    let colHasContent = false;\n    for (let y = top; y <= bottom; y++) {\n      const i = (y * width + right) * 4;\n      if (!isBackground(pixels[i], pixels[i+1], pixels[i+2], pixels[i+3])) {\n        colHasContent = true;\n        break;\n      }\n    }\n    if (colHasContent) break;\n  }\n  \n  return { x: left, y: top, width: right - left + 1, height: bottom - top + 1 };\n};\n\nexport const processFilesClientSide = async (filesQueue, options, onProgress) => {\n  const zip = new JSZip();\n  const { baseName, startNumber, optCrop, optTrimOnly, optAddMargin, optResize } = options;\n\n  let processedCount = 0;\n\n  for (let i = 0; i < filesQueue.length; i++) {\n    const fileItem = filesQueue[i];\n    const file = fileItem.file;\n    \n    if (onProgress) onProgress(`Przetwarzanie: ${file.name} (${i + 1}/${filesQueue.length})`);\n\n    try {\n      const img = await loadImage(file);\n      let canvas = document.createElement('canvas');\n      canvas.width = img.width;\n      canvas.height = img.height;\n      let ctx = canvas.getContext('2d', { willReadFrequently: true });\n      \n      // Rysujemy oryginał\n      ctx.drawImage(img, 0, 0);\n\n      // Zmienne pomocnicze\n      let hasBackgroundContext = false;\n      let wasTrimmed = false;\n\n      // 1. DETEKCJA TŁA (dla optCrop - tryb Auto)\n      if (optCrop || optTrimOnly) {\n          const corners = [\n            { x: 0, y: 0 },\n            { x: img.width - 1, y: 0 },\n            { x: 0, y: img.height - 1 },\n            { x: img.width - 1, y: img.height - 1 }\n          ];\n          const pixels = ctx.getImageData(0, 0, img.width, img.height).data;\n          \n          for(let corner of corners) {\n             const idx = (corner.y * img.width + corner.x) * 4;\n             const r = pixels[idx];\n             const g = pixels[idx+1];\n             const b = pixels[idx+2];\n             const a = pixels[idx+3];\n             \n             // Biały (>230) lub Przezroczysty (<255)\n             if ((r > 230 && g > 230 && b > 230) || a < 255) {\n                 hasBackgroundContext = true;\n                 break;\n             }\n          }\n      }\n\n      // 2. KADROWANIE (Trim)\n      if (optCrop || optTrimOnly) {\n          const bounds = getTrimmedBounds(ctx, canvas.width, canvas.height);\n          if (bounds) {\n              if (bounds.width < canvas.width || bounds.height < canvas.height) {\n                  wasTrimmed = true;\n              }\n\n              const trimmedCanvas = document.createElement('canvas');\n              trimmedCanvas.width = bounds.width;\n              trimmedCanvas.height = bounds.height;\n              const trimmedCtx = trimmedCanvas.getContext('2d');\n              \n              trimmedCtx.drawImage(\n                  canvas, \n                  bounds.x, bounds.y, bounds.width, bounds.height, \n                  0, 0, bounds.width, bounds.height\n              );\n              \n              canvas = trimmedCanvas;\n              ctx = trimmedCtx;\n          }\n      }\n      \n      // 3. DECYZJA O MARGINESIE\n      // Auto: (optCrop && !optTrimOnly) AND (hasBackground OR wasTrimmed)\n      const autoMargin = (optCrop && !optTrimOnly && (hasBackgroundContext || wasTrimmed));\n      const forceMargin = optAddMargin;\n      \n      const willAddMargin = autoMargin || forceMargin;\n      const marginTotal = willAddMargin ? 10 : 0; // 5px + 5px\n      \n      // 4. SKALOWANIE DO LIMITU (3000x3600)\n      const MAX_W = 3000;\n      const MAX_H = 3600;\n      const maxContentW = MAX_W - marginTotal;\n      const maxContentH = MAX_H - marginTotal;\n      \n      let currentW = canvas.width;\n      let currentH = canvas.height;\n\n      if (currentW > maxContentW || currentH > maxContentH) {\n          // Skalowanie zachowujące proporcje (fit inside)\n          const scale = Math.min(maxContentW / currentW, maxContentH / currentH);\n          \n          const newW = Math.floor(currentW * scale);\n          const newH = Math.floor(currentH * scale);\n          \n          const scaledCanvas = document.createElement('canvas');\n          scaledCanvas.width = newW;\n          scaledCanvas.height = newH;\n          const scaledCtx = scaledCanvas.getContext('2d');\n          \n          // Wysoka jakość skalowania (browser default is usually ok for downscale)\n          scaledCtx.drawImage(canvas, 0, 0, newW, newH);\n          \n          canvas = scaledCanvas;\n          ctx = scaledCtx;\n          currentW = newW;\n          currentH = newH;\n      }\n\n      // 5. DODANIE MARGINESU\n      if (willAddMargin) {\n          const marginCanvas = document.createElement('canvas');\n          marginCanvas.width = currentW + 10;\n          marginCanvas.height = currentH + 10;\n          const marginCtx = marginCanvas.getContext('2d');\n          \n          marginCtx.fillStyle = '#ffffff';\n          marginCtx.fillRect(0, 0, marginCanvas.width, marginCanvas.height);\n          \n          marginCtx.drawImage(canvas, 5, 5);\n          \n          canvas = marginCanvas;\n          ctx = marginCtx;\n          currentW += 10;\n          currentH += 10;\n      }\n\n      // 6. DOPEŁNIENIE DO 500px (Padding)\n      if (optResize) {\n          const targetW = Math.max(currentW, 500);\n          const targetH = Math.max(currentH, 500);\n          \n          if (currentW < targetW || currentH < targetH) {\n              const paddedCanvas = document.createElement('canvas');\n              paddedCanvas.width = targetW;\n              paddedCanvas.height = targetH;\n              const paddedCtx = paddedCanvas.getContext('2d');\n              \n              paddedCtx.fillStyle = '#ffffff';\n              paddedCtx.fillRect(0, 0, targetW, targetH);\n              \n              const dx = Math.floor((targetW - currentW) / 2);\n              const dy = Math.floor((targetH - currentH) / 2);\n              \n              paddedCtx.drawImage(canvas, dx, dy);\n              \n              canvas = paddedCanvas;\n              ctx = paddedCtx;\n          }\n      }\n\n      // Finalne spłaszczenie na białe tło\n      const finalCanvas = document.createElement('canvas');\n      finalCanvas.width = canvas.width;\n      finalCanvas.height = canvas.height;\n      const finalCtx = finalCanvas.getContext('2d');\n      finalCtx.fillStyle = '#ffffff';\n      finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);\n      finalCtx.drawImage(canvas, 0, 0);\n\n      const blob = await new Promise(resolve => finalCanvas.toBlob(resolve, 'image/jpeg', 0.95));\n      \n      const fileName = `${baseName}-${startNumber + i}.jpg`;\n      zip.file(fileName, blob);\n      \n      processedCount++;\n\n    } catch (err) {\n      console.error('Błąd przetwarzania klienta:', err);\n      if (onProgress) onProgress(`Błąd: ${file.name}`);\n    }\n  }\n\n  if (onProgress) onProgress('Pakowanie ZIP...');\n  const zipBlob = await zip.generateAsync({ type: 'blob' });\n  return zipBlob;\n};\n"],"names":["loadImage","file","resolve","reject","img","getTrimmedBounds","ctx","width","height","pixels","top","bottom","left","right","isBackground","g","b","a","isWhite","isTransparent","rowHasContent","x","i","colHasContent","y","processFilesClientSide","filesQueue","options","onProgress","zip","JSZip","baseName","startNumber","optCrop","optTrimOnly","optAddMargin","optResize","processedCount","canvas","hasBackgroundContext","wasTrimmed","corners","corner","idx","r","bounds","trimmedCanvas","trimmedCtx","willAddMargin","marginTotal","MAX_W","MAX_H","maxContentW","maxContentH","currentW","currentH","scale","newW","newH","scaledCanvas","scaledCtx","marginCanvas","marginCtx","targetW","targetH","paddedCanvas","paddedCtx","dx","dy","finalCanvas","finalCtx","blob","fileName","err"],"mappings":"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"}