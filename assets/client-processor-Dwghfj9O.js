import{J as U}from"./vendor-529iNPX7.js";console.log("Client processor module loaded");const X=M=>new Promise((l,f)=>{const e=new Image;e.onload=()=>l(e),e.onerror=f,e.src=URL.createObjectURL(M)}),Z=(M,l,f)=>{const e=M.getImageData(0,0,l,f).data;let d=0,m=f,w=0,x=l;const p=(s,i,n,b)=>{const A=s>230&&i>230&&n>230,k=b<255;return A||k};for(d=0;d<f;d++){let s=!1;for(let i=0;i<l;i++){const n=(d*l+i)*4;if(!p(e[n],e[n+1],e[n+2],e[n+3])){s=!0;break}}if(s)break}if(d===f)return null;for(m=f-1;m>=d;m--){let s=!1;for(let i=0;i<l;i++){const n=(m*l+i)*4;if(!p(e[n],e[n+1],e[n+2],e[n+3])){s=!0;break}}if(s)break}for(w=0;w<l;w++){let s=!1;for(let i=d;i<=m;i++){const n=(i*l+w)*4;if(!p(e[n],e[n+1],e[n+2],e[n+3])){s=!0;break}}if(s)break}for(x=l-1;x>=w;x--){let s=!1;for(let i=d;i<=m;i++){const n=(i*l+x)*4;if(!p(e[n],e[n+1],e[n+2],e[n+3])){s=!0;break}}if(s)break}return{x:w,y:d,width:x-w+1,height:m-d+1}},V=async(M,l,f,e)=>{const d=e?null:new U,{baseName:m,startNumber:w,optCrop:x,optTrimOnly:p,optAddMargin:s,optResize:i}=l;let n=0;for(let b=0;b<M.length;b++){const k=M[b].file;f&&f(`Przetwarzanie: ${k.name} (${b+1}/${M.length})`);try{const h=await X(k);let o=document.createElement("canvas");o.width=h.width,o.height=h.height;let I=o.getContext("2d",{willReadFrequently:!0});I.drawImage(h,0,0);let T=!1,E=!1;if(x||p){const t=[{x:0,y:0},{x:h.width-1,y:0},{x:0,y:h.height-1},{x:h.width-1,y:h.height-1}],a=I.getImageData(0,0,h.width,h.height).data;for(let r of t){const c=(r.y*h.width+r.x)*4,v=a[c],R=a[c+1],J=a[c+2],O=a[c+3];if(v>230&&R>230&&J>230||O<255){T=!0;break}}}if(x||p){const t=Z(I,o.width,o.height);if(t){(t.width<o.width||t.height<o.height)&&(E=!0);const a=document.createElement("canvas");a.width=t.width,a.height=t.height;const r=a.getContext("2d");r.drawImage(o,t.x,t.y,t.width,t.height,0,0,t.width,t.height),o=a,I=r}}const L=x&&!p&&(T||E)||s,S=L?10:0,j=3e3,D=3600,W=j-S,$=D-S;let u=o.width,C=o.height;if(u>W||C>$){const t=Math.min(W/u,$/C),a=Math.floor(u*t),r=Math.floor(C*t),c=document.createElement("canvas");c.width=a,c.height=r;const v=c.getContext("2d");v.drawImage(o,0,0,a,r),o=c,I=v,u=a,C=r}if(L){const t=document.createElement("canvas");t.width=u+10,t.height=C+10;const a=t.getContext("2d");a.fillStyle="#ffffff",a.fillRect(0,0,t.width,t.height),a.drawImage(o,5,5),o=t,I=a,u+=10,C+=10}if(i){const t=Math.max(u,500),a=Math.max(C,500);if(u<t||C<a){const r=document.createElement("canvas");r.width=t,r.height=a;const c=r.getContext("2d");c.fillStyle="#ffffff",c.fillRect(0,0,t,a);const v=Math.floor((t-u)/2),R=Math.floor((a-C)/2);c.drawImage(o,v,R),o=r,I=c}}const g=document.createElement("canvas");g.width=o.width,g.height=o.height;const B=g.getContext("2d");B.fillStyle="#ffffff",B.fillRect(0,0,g.width,g.height),B.drawImage(o,0,0);const z=(t,a)=>new Promise(r=>t.toBlob(c=>r(c),"image/jpeg",a)),N=1.5*1024*1024,H=3*1024*1024;let y;if(y=await z(g,.99),y.size>N){let t=await z(g,.96);t.size<=H?y=t:(t=await z(g,.92),t.size<=H?y=t:(t=await z(g,.89),t.size<=H?y=t:y=await z(g,.85)))}const _=`${m}-${w+b}.jpg`;e?await e(y,_,k):d.file(_,y),n++}catch(h){console.error("Błąd przetwarzania klienta:",h),f&&f(`Błąd: ${k.name}`)}}if(!e)return f&&f("Pakowanie ZIP..."),await d.generateAsync({type:"blob"})};export{V as processFilesClientSide};
//# sourceMappingURL=client-processor-Dwghfj9O.js.map
